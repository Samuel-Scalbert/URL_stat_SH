Deep metric learning for visual servoing: when pose and
image meet in latent space
Samuel Felton, Élisa Fromont, Eric Marchand

To cite this version:

Samuel Felton, Élisa Fromont, Eric Marchand. Deep metric learning for visual servoing: when pose
and image meet in latent space. ICRA 2023 - IEEE International Conference on Robotics and Au-
tomation, May 2023, London, United Kingdom. pp.741-747, ￿10.1109/ICRA48891.2023.10160963￿.
￿hal-04003126￿

HAL Id: hal-04003126

https://inria.hal.science/hal-04003126

Submitted on 23 Feb 2023

HAL is a multi-disciplinary open access
archive for the deposit and dissemination of sci-
entific research documents, whether they are pub-
lished or not. The documents may come from
teaching and research institutions in France or
abroad, or from public or private research centers.

L’archive ouverte pluridisciplinaire HAL, est
destinée au dépôt et à la diffusion de documents
scientifiques de niveau recherche, publiés ou non,
émanant des établissements d’enseignement et de
recherche français ou étrangers, des laboratoires
publics ou privés.

Distributed under a Creative Commons Attribution 4.0 International License

Deepmetriclearningforvisualservoing:whenposeandimagemeetinlatentspaceSamuelFelton,´ElisaFromont,EricMarchandAbstract—Weproposeanewvisualservoingmethodthatcontrolsarobot’smotioninalatentspace.Weaimtoextractthebestpropertiesoftwopreviouslyproposedservoingmethods:weseektoobtaintheaccuracyofphotometricmethodssuchasDirectVisualServoing(DVS),aswellasthebehaviorandconvergenceofpose-basedvisualservoing(PBVS).Photometricmethodssufferfromlimitedconvergenceareaduetoahighlynon-linearcostfunction,whilePBVSrequiresestimatingtheposeofthecamerawhichmayintroducesomenoiseandincursalossofaccuracy.Ourapproachreliesonshaping(withmetriclearning)alatentspace,inwhichtherepresentationsofcameraposesandtheembeddingsoftheirrespectiveimagesaretiedtogether.Byleveragingthemultimodalaspectofthissharedspace,ourcontrollawminimizesthedifferencebetweenlatentimagerepresentationsthankstoinformationobtainedfromasetofposeembeddings.Experimentsinsimulationandonarobotvalidatethestrengthofourapproach,showingthatthesoughtoutbenefitsareeffectivelyfound.I.INTRODUCTIONVisualservoing(VS)isthetaskofcontrollingthemotionofarobotinordertoreachadesiredgoaloradesiredposeusingonlyvisualinformationextractedfromanimagestream[7].Thecameracanbemountedontherobot’sendeffectorordirectlyobservingtherobot.Visualservoingusuallyrequirestheextractionandthetrackingofvisualinformation(usuallygeometricfeatures)fromtheimageinordertodesignthecontrollaw.ThechoiceoffeaturesisacrucialaspectofVS,asitimpactstheservoingbehaviour(namelytheconvergencetothetargetposeandthetrajectoryin3Dspace).Geometricfeaturesareusuallysplitintotwocategories.Thefirstone,Image-BasedVS(IBVS),uses2Dprimitivesintheimagespace,suchaspoints[28],lines[1]ormoments[6],inordertocreatethecontrollaw.Thesecondcategory,namedPose-BasedVS(PBVS)[29],[6],usesimageinformationtoestimatethecamerapose,whichcanbeusedtodirectlycontroltherobot’smotion.ThePBVScontrollawisoftenseenasthemostpracticalandoptimalone:ifthecameraposeisperfectlyestimated,thentheschemeisgloballyconvergentandthetrajectoryistheshortestpathtothegoalpose,bothintranslationandrotation.Inallcases,geometricfeaturesmustbeextracted,aswellasmatchedbetweencurrentanddesiredimages.Asthisisanerror-proneprocess,anotherwayofperformingVShasdeveloped.Byusingphotometricfeatures,suchasrawpixelintensities,featureextractionisavoided[9].InDirectVS(DVS),thedifferencebetweenpixelintensitiesisminimized,whichleadstoveryaccuratepositioning,butwithAuthorsarewithUnivRennes,Inria,CNRS,Irisa,Rennes,FranceEmail:{samuel.felton,elisa.fromont,eric.marchand}@irisa.franunpredictabletrajectoryandasmallconvergencedomain,sincethecostfunctiontominimizeishighlynon-linear.Toalleviatethelatterproblem,asolutionistorepresentimagesbylowerdimensionalfeaturesthatbettercorrelatetothepose.Multiplerepresentationshavebeenstudied:[2]expressesanimagewithphotometricmoments.In[22],ser-voingisperformedinthefrequencydomain,whereonlythesmoothlyvaryinglow-frequencyinformationispreserved.Asimilar,learning-basedapproachwasproposedin[21],whereprincipalcomponentanalysisisusedtoprojectonasubspace,whichmaximallypreservestheinformationofanimageset.Inspiredbythiswork,wepreviouslyproposedAEVS[11],projectingimagesinthelatentspaceofanautoencoder.BetweenalltheseVSmethods,atrade-offbecomesap-parent:theeasierfeatureextractionis,theharderservoingbecomes.OnoneendofthespectrumliesDVS,withnoextractionbutahighlynon-linearcostfunction.Ontheotherend,PBVSrequiresestimatingthepose(froma3Dmodelofthescene/objectordirectlyfromdata)butthecostfunctionissmooth.Poseestimationalsohasthedraw-backofintroducingsomenoiseintotherobot’strajectory.However,ascamerarelocalizationisafundamentaltaskofmanycomputervisionapplications,ithasbecomeatopicofinterestforthedeeplearningcommunity,thatseekstoreplaceorsupportclassicalgeometricapproacheswithaneuralnetwork.OneofthefirstworkswasPoseNet[17],thatusesaConvolutionalNeuralNetwork(CNN)toregressthecameraposeinascene(position+orientation)fromasingleRGBimage.ThisprocesswasrepurposedforVS,withmultipleworkssuchas[4],[24],[31]whichemployaCNNtoestimatetheposedifferencebetweencurrentanddesiredimages.ThisdifferenceisthenfedtothePBVScontrollawinordertomovetherobotclosertothetargetpose.Servoingisthenfullydependentonthisestimation,and[33]notesthatinthecaseoforientationregression,trainednetworksmaystillyieldalargeerror,astherotationspaceisnotsmoothandcontinuous.Furthermore,Insomecases,thedifferencebetweentranslationalandrotationalmotionsmaybenonobservable.Ourworkproposestoreplacethestandardposeregressionapproachwithmetriclearning.Inmetriclearning,weseektolearnasimilarityfunctionbetweensamplesthatisdependentonthetasktobeaccomplished.Theseapproachescanbeusedtogroupimagesofthesameconcept(highsimilarity),whilepushingawayimagesofdifferentconcepts(lowsimilarity).Thisprinciplecanbeappliedtomanytasks,includingclassification[13],objecttracking[10]orcamerarelocalization[3].WeproposetousemetriclearningtoshapethelatentspaceinwhichweperformVS.Weaimtolearnaspaceinwhichthesimilaritybetweentwolearnedrepresentationscorrelateswiththedistancebetweentheirrespectivecameraposes.Thisrepresentationspacecanbeseenasanintermediatemanifoldbetweenposesandimagesonwhichweprojectbothmodal-ities.Doingso,weproposeanewservoingcontrollawthatcombinestheoptimalbehaviorofPBVSwiththeaccuracyandsimplicityofphotometricmethods.InSectionII,wegiveanoverviewofVS,detailingthegenericminimizationframework,aswellaspresentinghowPBVSandvisualservoinginanautoencoderlatentspaceareachieved.Withthisknowledge,weintroduceourmethodinSectionIII,thatconstrainsthelatentspacetohavegoodpropertiesforVSviametriclearning.Byleveragingthemultimodalaspectofthissharedspace,ourcontrollawminimizesimageerrorthankstoinformationobtainedfromasetofposeprojections.Finally,InSectionIV,wepresentsimulatedandreal-worldexperimentsthatvalidateourapproachandillustrateitsproperties.II.RELATEDWORKSA.VisualservoingframeworkVisualservoingaimstoreachadesiredposer∗,fromitsarbitrary,currentposer.Manyroboticstasks,suchasnavigation,tracking,objectpickingcanbeviewedthroughthisprism,e.g.navigationisasuccessionofpositioningtasks.VSthusseekstosolveanoptimizationproblem,findingtheposeclosesttor∗thatminimizesanerrorfunctione:(cid:98)r=argminre(r).(1)Ifeiswelldesignedande=0,then(cid:98)r=r∗.Sincetheposermaybeunknownduringservoing,eisdefinedase=s(r)−s∗,whichisthedifferencebetweenwhatthecameraseesatthecurrentposes(r)=s,andwhatitshouldseeatthedesiredposes∗.Asstatedbefore,thechoiceoffeaturessisimportantasitconditionsthe3Dtrajectory,theconvergencedomain—howfarcanrbefromr∗beforeVSdiverges—andthefinalaccuracy—howcloseis(cid:98)rtor∗.Featuresmaylieintheimagespace(IBVS),inthe3Dworld(PBVS)orinphotometricspace(e.g.consideringpixelintensities[9]).Inallcases,therelationshipbetweenthevariation(intime)ofthefeaturessandthecameravelocityvmustbeestablished:˙s=Lsv(2)whereLs=∂s∂riscalledtheinteractionmatrix.Byinvertingthisequation,wecanthendefinethecontrollawthatbestminimizestheerrore:v=−λL+se(3)whereλisagainparameterL+sthepseudo-inverseofLs.Thecomputedvelocityvcanbeusedtomovetherobot’send-effectorclosertothedesiredposer∗.VSoperatesinaclosedloop,withtheminimizationofebeingperformedinaniterativemanner.B.Deeplearningforpose-basedVSAposer=(cid:0)tθu(cid:1)⊤isanelementofSE(3)=R3×SO(3)thegroupthatrepresentsrigidtransformations,combiningtranslationtandrotationθu,whereuistheaxisaroundwhichtorotateandθistheangleoftherotation.ItmayalsoberepresentedasahomogeneousmatrixoTc,thatexpressestheposeofcameraFc(oranyotherframe)inareferenceframeFo(suchasonegivenbytheoriginofasceneobjecto).Thedisplacementbetweentwoposes∆r=c∗Tccanbecomputedasc∗Tc=c∗TooTc.DeepLearning(DL)haspreviouslybeenusedtoestimatethecameraposer,givenasingleimageI.ThefirstmajorworktoaccomplishthiswasPoseNet[17].Givenadatasetofimagesandtheirassociatedposes(expressedinacommonframe),aCNNistrainedtominimizethefollowinglossfunction:Lpose(t,q)=∥ˆt−t∥2+β∥ˆq−q∥2(4)whereˆt,ˆqarethepredictedpositionandorientationofthecameraandt,qisthegroundtruth.Theorientationqcanbeexpressedasaunitquaternion,orasanaxis-angleθu.βisanimportanthyperparameter,thatbalancesthelearningofbothtranslationandorientation.Thisweightingisrequiredasthetwoquantitiesareondifferentscales,anditmustcarefullybetweakedinordertogetsensibleresults.In[16],theauthorsintroducedamulti-tasklossthatautomaticallylearnstheweighting,improvinguponthemanualtuningofβ.Giventwoimages,itisalsopossibletoregresstheposedifference∆r[4],[24],[31].∆rcanthenbepluggedintothePBVScontrollaw[29],[7]tocomputev.TheinteractionmatrixofaposeexpressedinafixedframeFc∗(alsovalidforFo)isdefinedas[7]:Lr=(cid:18)c∗Rc00Lθu(cid:19)(5)withc∗RcarotationmatrixandLθutheinteractionmatrixdefinedin[8].If∆risperfectlyestimated,thenthecontrollawv=−λL−1r∆rensuresthatthe3Dtrajectoryisageodesicbothintranslationandrotation.C.ServoinginlatentspaceIn[11],weintroducedAEVS,amethodtoperformVSinthelatentspaceofanautoencoder(AE).ThisAEisaneuralnetworkthatlearnsaprojectionfromanimagetoalowerdimensionalrepresentation(encoder),aswellastheinversemapping(decoder).ThisapproachissimilartoPCA-basedVS[21],exceptthatAEslearnnon-linearprojections,whichPCAcannot.Theautoencodingobjectiveistheminimizationofthereconstructionerror.ConsideringtwoembeddingszI,zI∗,thecontrollawisoftheform:v=−λL+zI(zI−zI∗)(6)whereLzIiscomputedanalyticallybyapplyingthechainrule,findingLzIisthecompositionoftheencoderJacobianandtheinteractionmatrixoftheinputimage,detailedin[9],[20]:LzI=∂zI∂I∂I∂r.Althoughthisprocessisappliedtoimages,thesamereasoningcanbeappliedtoanencoderforanytypeofinputs,aslongastheinteractionmatrixoftheinputcanbedefined.Whilethisapproachimprovesuponotherphotometricdimensionalityreductionschemes,ithassomedrawbacks.First,thetrainingobjectiveisweaklycorrelatedtoposeestimation.ThismakesithardtoknowwhetherthelatentspaceofatrainedAEwillgivegoodresultswhenappliedtoVS.Second,theinteractionmatrixLzIdependsontheinteractionmatrixofDVS,whichisknowntoleadtounpredictabletrajectoriesduetoahighlynon-linearcostfunction[9].Finally,AEVSrequiresthecamera’sintrinsiccalibration,aswellasanestimateofthedepth:averycoarseestimationworks,butdegradesthetrajectory.D.MetriclearningMetriclearningaimstolearnasimilarityfunctionbetweentwocomparedinputs.Thesimilaritymeasureisdefinednotintheinputspace(e.g.comparingpixelintensities)butratherfromthefactorsthatunderliethevariationsofthedata.Asanexample,metriclearningmaylearntogroupimagesofthesamesubject(e.g.class,landmarkorperson)whileenforcingalargemarginbetweendissimilarconcepts.Metriclearningisoftencoupledtonearestneighborsearch.Amajorityofthemetriclearningalgorithmsfocusesonbinarysupervisiontolearnameaningfulmetric:eithertwosamplesaresimilarortheyarenot.Thisisbestseeninthecommontripletloss[13]Ltriplet(xa,xp,xn)=max(d(xa,xp)−d(xa,xn)+ϵ,0)thatcomparesananchorrepresentationxawithsimilaranddissimilarsamplesxp,xn,whereϵisamarginparameterthatgivestheseparationthresholdbetweenpositiveandnegativedatapoints.Itisalsopossibletolearnsmoothlyvaryingsimilarityfunctionswithcontinuousmetriclearning,asstudiedin[18],[3].Anapplicationofcontinuousmetriclearningthatiscloselytiedtoourworkcanbefoundin[3].ThisapproachlearnsafeaturespacewheretheEuclideandistancebetweentworepresentationsisdirectlycorrelatedwiththeoverlapbetweentwoimages,i.e.howmuchofthesceneisvisibleinbothcameras.Anadditionalposedifferenceregressoristhentrainedtoobtainabetterestimateforthecamerarelocalizationtask.Thisnetworkcomparesthequerywithitsnearestneighbors.Anotherworkcloselyrelatedtooursis[15]whichlearnsafeaturespacethatisequivarianttocameramotion.Thisapproachusesdiscretemetriclearningandadiscretenumberofmotionpatterns(e.g.moveforward,rotateleft/right)islearned.Usinglatentrepresentationsalsoallowsprojectingmul-tiplemodalitiesofthesamedatatocomparethemwithasinglemetric,inacommonspace.In[27],authorstransformtextandimagesandmapthemtoasharedspace.Metriclearningthenallowsfortheretrievalofimagesthatmatchagiventextualquery.Similarly,[25]embedspointclouds,textualtasks,andtrajectoriesinthesamespace,sothatthebestfittingtrajectorymaybeselectedgivenatask.Multiplemodalitiescanalsobeusedinaudioprocessing,byeithercreatingamusicsample-tagassociation[30],oranacoustic-linguisticrelationship[26].III.METRICLEARNINGFORVISUALSERVOINGThissectionpresentsournovelapproachtoVisualSer-voing,thatleveragesdeepmetriclearninginordertoframeVSinalearnedspace.Wefirstdetailthereasoningbehindourmethod,thenpresentourtrainingprocedure,thatshapesthelatentspace.Finally,wedescribehowVSisperformedinthisnewlatentspace.A.ObjectiveSE(3)rjLrjrkII∗IψψϕϕZzIzI∗zrjLzrjzrjzrkCameraFig.1:Theproposedlatentspaceforvisualservoing.BothimagesandposesareprojectedinZ,wheretheycanbecompared.Inthispaper,ourgoalistoproposealatentspaceservoingschemewithabehaviorsimilartoPBVS,overcomingthelimitationsofotherdeeplearning-basedmethods.Todoso,weproposetocreateamultimodallatentspaceZ,inwhichbothposeandimagerepresentationsaremapped.Aposer∈SE(3)mapstoanimageI∈Iviaacamera.Aposerjmapstoanembeddingzrj,whiletheimageacquiredatrjisnotedzIj.Therelationshipbetweenlatentspaceandimages/posesisillustratedinFigure(1)WearguethatforthebestVSbehavior,thedistancebetweentwoembeddingsshouldbeequaltothedistancebetweentheirunderlyingposes:dZ(zj,zk)=dSE(3)(rj,rk),wheredZistheEuclideandistance:dZ(zj,zk)=∥zj−zk∥2(7)Thedistanceconstraintholdstrue,whetherzj,zkareimageorposeprojections,i.e.zj=zIjorzj=zrj.Ifthispropertyisperfectlymet,itfollowsthat:•foragivenimageIj,acquiredatposerj,dZ(zIj,zrj)=0.Thisissimilartoanabsoluteposeregressionobjective;•fortwoimagesIj,Ikacquiredatrj,rk,theconstraintdZ(zIj,zIk)=dSE(3)(rj,rk)isakintoestimatingtherelativeposedifferencebetweenrjandrkfromtheimages;•finally,dZ(zIj,zIk)=dZ(zrj,zrk).Asthetwocostfunctionsarethesame,usingtheinteractionmatrixlinkedtoaposerepresentationinaservoingcontextisvalidfortheminimizationofdZ(zIj,zIk).Wethusseektolearnaspacethatisequivariantto3Dmotion.ThisisidealforVS,aswewishforfeaturesthathaveastrongandstraightforwardrelationtopose.Moreover,weseektoexplicitlylearnaspacethatisinvarianttoperturbationsP∈P,suchaslightingchangesorocclusions(i.e.zI+P=zI).B.LearninganSE(3)-equivariantspaceTolearnthespaceZ,weproposetousetwodistinct,parallelneuralnetworks.Thefirstisϕ:SE(3)→Z,thatmapsaposertoanembeddingzr=ϕ(r).Thesecondmodelψ:I→Z,mapsanimageItoitslatentrepresentationzI=ψ(I).InordertoshapeZ,wedeviseourlossfunctionthatisbasedonthedistancesbetweenlatentrepresentations.Whilemostmetriclearningapproachesfocusonclusteringproblems,werequireourdistancestobecontinuouslymean-ingfulasin[3],[18].Insteadofcomparingtheembeddingsofspecifictuples(rj,Ij,rk,Ik),weadoptafull-batchap-proach,comparingarepresentationwitheveryotherinthebatch.Todoso,weleveragethedistancematricesinSE(3)andinthelatentspace,viewinganembeddingbatchasafullyconnectedgraph.Byusingthisdenseapproach,weencouragethelatentrepresentationstopositionthemselveswithrespecttoeveryneighbor,providingamorestabletrainingsignalforthemodelsϕandψ.Totraintheposeencoderϕ,OurfirstlossseekstoenforcetheequivariancewithSE(3)whenconsideringposeprojec-tions.AsSE(3)hasnotruedistancemetric,aweightingbetweentranslationtandrotationθudistancesmustbeintroducedtocreateapseudo-metricdSE(3),asin[16].Weproposetodefinetheweightingsfromthedataandnormalizethetranslationalandrotationaldistancesbytheiraveragevalueinthedataset.Tocomputethetranslation/rotationdistancesbetweentwoposesrj,rk,wefirstcomputetheposedifference∆r=(∆t,∆θu)wethendefineasingledataset-awaremetriconSE(3),asdSE(3)(rj,rk)=1wt∥∆t∥2+1wθu∆θ(8)wherewt,wθuareaveragesoftranslationalandrotationaldistances,computedonasubsetofthedataset.WithdSE(3)defined,weintroduceourfirstloss.ConsideringabatchofBsamples,weseektominimizeLϕ,SE(3)=1B2B(cid:88)j=0B(cid:88)k=0(dSE(3)(rj,rk)−∥zrj−zrk∥2)2(9)Thislossisfairlystraightforwardtominimize,asϕhasaccesstothefullposeinformation,anditsmaintaskistotransformthecombinationoftranslationalandrotationalmetricsintoasingleeuclideandistance.Ofcourse,sinceposesarenotavailableduringVS,werequireψtoprojectanimagetothesameembeddingasitsassociatedpose,aswellasmatchthedistanceswithotherposes.Thisismodeledby:Lψ,ϕ=1B2B(cid:88)j=0B(cid:88)k=0(∥zIj−zrk∥2−∥zrj−zrk∥2)2(10)Bytransitivity,Lψ,ϕalsominimizes(dSE(3)(rj,rk)−∥zIj−zIk∥2)2.Tolearninvariancetoperturbations,weincorporateperturbedsamplesintheimagebatch.ThesenoisysamplesareexploitedinLψ,ϕ.Moreover,theimagerepresentationsassociatedtoasingleposerj(theoriginalimageanditsPperturbedversions)arecompared,andtheirdistancetoeachotherminimized:LPj=1P2P(cid:88)m=0P(cid:88)n=0∥zIj+Pm−zIj+Pn∥2(11)Toobtainourfinaltrainingobjective,wesumupthelossesL=Lϕ,SE(3)+Lψ,ϕ+(cid:88)jLPj(12)TheimpactofeachlossisvisualizedinFigure(2).Itcanbeseenthattheobjectivesdesignedaboveactaspush-pullforces,movingtheembeddingstorespectthedistanceconstraints,aswellasminimizetheinfluenceofperturba-tions.Bycomparingarepresentationwitheveryneighbor,weensurethatasingleiterationforcesanembeddingtowardsamorestablelocation.zIjzrjzrkzrldZ(zIj,zrk)dZ(zrj,zrk)PdSE(3)(rj,rk)dSE(3)(rj,rl)−∇Lψ,ϕ−∇Lϕ,SE(3)−∇LP,jFig.2:Shapingthelatentspacewithmetriclearning.Wecomparetherepresentationsofasamplejwiththeirneigh-bors.Whileillustratingonlythegradientsforj,thelossisappliedtoeveryothersample.C.TrainingpolicyToconstituteourbatchesofdata,werandomlysampleN=64posesfromthedataset,andaddtheirM=3closestneighborsfoundinasubsetofthedatatoensurethattheconstraintsaremetbothgloballyandlocally.Foreachimage,wealsogenerateP=2perturbations.ComparingtoAEVS[11],notusingadecoder(discardedforVS)networkallowsforlargerbatches.TheperturbationsconsistinaddingGaussiannoise,changingthebrightnessoftheimageandperformingrandomerasing[32].Theimage/posegenerationprocessisthesameastheonepresentedin[11],leveragingsimulationtocreatedatacheaplyandefficiently.WesetthedimensionalityofthelatentspacesothatZ=R32.TheimageencoderψisaResNet-34[12],withthemodificationsof[11],i.e.replacingbatchnormalization[14]withweightnormalization[23]andtheendaveragepoolingwithagroupconvolution.Thepose-embeddingnetworkϕisa5-layerperceptronofdimensions6→32→64→128→64→32,withReLUactivationsaftereachhiddenlayer.Thenetworksarejointlytrainedfor50epochs,onadatasetof100Ksamples.Trainingtakesaround8hwithaQuadroRTX6000.GradientdescentisperformedwiththeAdamoptimizer[19]andalearningrateof10−4.Withournetworkstrained,wecanfinallyperformVSinthelatentspace.D.VisualservoinginlatentspaceOurapproachtoVSistwo-pronged,basedonthemulti-modalnatureofZ.WefirstembedthecurrentanddesiredimageszI=ψ(I),zI∗=ψ(I∗)inZtoobtaine=zI−zI∗.Tominimizee,werequireaninteractionmatrix,thatgivesusthecontroldirections.BeforeVSstarts,weprojectasetofNposes{zr1,...zrN}={ϕ(r1),...,ϕ(rN)}inthelatentspace,alongwiththeirinteractionmatrix,thankstothemethoddescribedinSectionII-C.ThelatentinteractionmatrixisthendefinedasLzrj=∂zrj∂rjLrj,with∂zrj∂rjtheJacobianofϕwithrespecttorj(computedviaforwardpropagation)andLrjgivenbyEquation(5).BecauseweminimizeLψ,ϕ(Equation(10)),WecanapproximatetheinteractionmatrixatzIasaninterpolationofitsneighbors’interactionmatrices.WethushaveaK-NearestNeighbors(KNN)regressionproblem,definedas:Lzr=K(cid:88)j=0αjLzrjwithαj=∥zrj−zI∥2(cid:80)Kk=0∥zrk−zI∥2(13)Toobtaintheposeembeddingsset,wegenerateposesona6Dgrid(displacementsintranslationandrotation),andoversamplenearzI∗.Inourexperiments,wethuscreateasetof1MposerepresentationsthatcanbeusedforKNN.Tobecomputationallytractable,westoretheminaKD-tree[5].Other,smarter,lessmemorydemandingsamplingstrategies,basedonthevaluesofbothzIandzI∗,arepossible.Wehoweverfoundthatthisstraightforwardapproachworkswellinpractice.UnlikeAEVS,theinteractionmatricesoftheposerepresentations(andthusthenetworkJacobian)arecomputedoffline.Fittingthepiecestogether,thefinalcontrollawissimplyv=−λL+zr(zI−zI∗)(14)Inthenextsection,weexplorethebehaviorofthisVSscheme,bothinsimulationandona6DOFrobot.IV.EXPERIMENTSANDRESULTSA.SimulationvalidationWestartourexperimentalvalidationwithalargescaleexperiment:werun500VStaskswithmultiplemethods.Theinitialpositionsarechosenwitha”look-at/look-from”scenario:wesamplecamerapositionsinavolumeofdimen-sions1.2m×1.2m×0.3m,centeredonthedesiredposition.wethensamplethefocal(look-at)pointsofthecamerasontheplanarscene,withadistancetothedesiredfocalpointsbetween8cmand32cm.Thesceneisaposterofdimensions80cm×60cm,andwesetthedesiredcameraelevationto60cm.Fromthecamerapositionandfocalpoint,webuildthecameraorientation,towhichweaddarotationaroundtheopticalaxis∈[−120◦,120◦].Theaverageinitialposeerroris47cm±16cm,74◦±28◦.Weexperimentwithmultiplemethods,thefirstonebeingapurephotometricscheme(DVS)[9].WealsocomparewithAEVS[11],aswellasaPBVSvisualservoingap-proachwhichusesaCNN-basedposeregressionapproach,asdevelopedin[24],[4](referredasPBVS-CNN).Toeasetrainingandimproveresults,weadopttheautomaticweightinglossof[16]thatbalancestranslationandrotationerrorsinEquation(4).ForbothAEVSandPBVS-CNN,weusethenetworkanddatadescribedinSectionIII-C.Forourmethod,weexploredifferentnumbersofneighborsK.Wefirstreportthepercentageofsamplesthatconvergenceforeachmethod.AsampleisdefinedashavingconvergediftheVSmethodsignificantlyreduces(byatleast90%)theinitialpositioningerrorandthefinalvelocitiesarecloseto0.Forthosesamples,wemeasuretheendpositioningerror,aswellastheAbsolutePoseError(APE),averagedoveralliterationsofatrajectory,whichdescribeshowfarthemethodstraysfromthegeodesicofPBVS.Theotherincludedmetricsarethemeanlengthratios:thelengthoftrajectoryoftheobservedmethoddividedbythelengthofthePBVStrajectory.AscanbeseeninTableI,ourmethodisabletoconvergereliablyandaccurately,withapositioningerrorthatiscomparabletophotometricmethodsinthecaseofcleantargetimagesI∗(noted✓inthetable),whilehavingafarlargerdomainofconvergence.WecanobservethatalargervalueforKleadstoamorestableandaccuratepositioning.LookingattheresultsofthePBVS-CNN,itcanbeseenthattheendpositioningerrorissubpar(3.3cm,1.71◦onaverage).Thetrajectorystatistics(APEandlengthratio)showthatourmethodisfarclosertothebehaviorofPBVS,comparedtoAEVSorDVS.ThisismadeexplicitinFigure(3b).TheoverallstatisticswhenconsideringcaseswhereI∗isperturbed(noted✗)highlightthatourmethodbetterhandlesvariationsinlightingandocclusions.Whilebothconvergenceandaccuracydegrade,theyremainabovethatoftheposeestimator,evenoncleanimages.Next,weexploretheservoingbehaviorinthelatentspace.Weperform8trajectories,wheretheinitialerrorsaredisplacementsonthex,yaxes,withaninitialerrorof20cm.Wethenvisualizethetrajectoriesinthelatentspacebyprojectingina2D-subspacewithPCA(explainedvariance≈96%).AscanbeseeninFigure(3a),theminimizationofeinthelatentspaceleadstonearlystraightlinesinthelatentspace.Theerrorbetweenposeembeddingsalsocorrelateswellwiththeerrorfromimagerepresentations.CleanI∗Converged↑Enderror↓APE↓Lengthratio↓%mm◦cm◦DVS[9]✓9.80.0±0.00.0±0.017.32±12.4831.0±14.352.6±4.9AEVS[11]✓33.60.01±0.00.0±0.02.74±6.362.66±6.42.75±4.85PBVS-CNN,e.g.[4]✓75.633.52±6.451.71±0.653.13±1.041.85±0.961.11±0.08✗36.832.21±15.712.37±1.574.0±0.742.55±0.641.12±0.1Ours,K=1✓99.23.02±1.210.21±0.120.71±0.881.59±3.281.46±0.97✗73.819.42±12.771.96±1.283.01±0.713.68±2.331.33±0.32Ours,K=50✓100.00.04±0.030.0±0.00.4±0.721.08±2.51.18±0.23✗76.019.29±12.811.92±1.283.31±0.613.72±1.61.14±0.11TABLEI:ComparativeresultsofdifferentVSmethodson500trajectories.Errorandtrajectorystatisticsarereportedforcasesthatconverge.Formetricsmarkedwith↑,higherisbetter.Lowerisbetterwhenmarked↓.kc∗tck2=20cm10cm5cm1cm(a)x(m)−0.3−0.2−0.10.0y(m)−0.4−0.3−0.2−0.1z(m)−0.7−0.6−0.5−0.4PBVSDVSAEVSCNN-basedposeregressionOurs,K=1Ours,K=50(b)Fig.3:(a)PCAprojectionoftrajectorieszI−zI∗inthelatentspace,for2Dmotions.Circlesshowtheerrorfortheposeembeddingszr−zr∗forvariousdistances.(b)3Dtrajectoriesofdifferentmethodsonasingleexample.B.RobotexperimentWealsodeployourmethodona6DoFgantryrobotandstudyitsbehavioronalargemotion.Fortheexperiment,showninFigure(4),theinitialdisplacementis∆r0=(−8.16cm,7.27cm,−29.98cm,24.86◦,−10.16◦,135.06◦),withalargeerrorintheimage(Figure(4c))andrunourmethodfor1.2kiterations.Notethatthismotion(andthustheimage)isfarfromwhatisseenduringtraining.Asservoingprogresses,theerrorinthelatentspace(Figure(4f))isquicklyminimized.Thefinalpositioningerroris∆rfinal=(0.09cm,0.08cm,−0.04cm,0.08◦,−0.12◦,−0.01◦),andtheresultingerrorinimagespaceislow(Figure(4d)).AsshowninFigures(4e,4g,4h),thetrajectorystartswithsomeunwantedmotiononthex,yaxes(compensatedbyy/xrotations),probablyduetothefactthatIliesoutsidethetrainingdomain.However,ourmethodrecoversandexhibitsasmoothdecreaseinpositioningerror.V.CONCLUSIONInthispaper,weproposedamethodthatallowsvisualservoingfrombothimageandposerepresentationsinacommonlatentspace.Thisnewvisualservoingschemecombinestheaccuracyofphotometricmethodswiththebehaviorofpose-basedapproaches.Ourexperimentsshowstrongresults,withalargeconvergencedomainandaccuratepositioning.Infutureworks,weplantoextendourmethod(a)(b)(c)(d)020040060080010001200iterations0.00.51.01.52.0Error∆tx∆ty∆tz∆θux∆θuy∆θuz(e)020040060080010001200Iterations−1.00−0.75−0.50−0.250.000.250.500.751.00Error(f)020040060080010001200iterations−0.4−0.3−0.2−0.10.00.10.2Cameravelocityvxvyvzωxωyωz(g)x(m)−0.20−0.15−0.10−0.050.000.050.10y(m)−0.10−0.050.000.050.100.15z(m)−0.25−0.20−0.15−0.10−0.050.00OursPBVS(h)Fig.4:Firstexperiment:(a)StartingimageI.(b)DesiredimageI∗.(c)StartingimagedifferenceI−I∗.(d)Finalimagedifference.(e)Posedifferencer−r∗.(f)ErrorinthelatentspacezI−zI∗.(g)Cameravelocitiesv.(h)3Dtrajectory.todealwithmorethantwomodalities(i.e.addingdepthorsegmentationinformation),sothatthevisualfeaturesatthecurrentanddesiredposesmaybedrawnfromdifferentdomains.Inaddition,webelievethatitispossibletoreducedatarequirementsbyincludingsomeformofself-supervisedlearning.Forinstance,smallmotionscouldbeusedtowarpanimageandgeneratenewweaklylabeledsamples.Supervisionwouldthenbeusedtolearnrepresentationstiedtolargemotions,whilesmallerdisplacementswouldbetakenintoaccountwithself-supervision.REFERENCES[1]N.Andreff,B.Espiau,andR.Horaud.Visualservoingfromlines.Int.JournalofRoboticsResearch,21(8):669–699,August2002.[2]M.Bakthavatchalam,O.Tahri,andF.Chaumette.ADirectDenseVisualServoingApproachusingPhotometricMoments.IEEETrans.onRobotics,34(5):1226–1239,October2018.[3]V.Balntas,S.Li,andV.Prisacariu.Relocnet:Continuousmetriclearningrelocalisationusingneuralnets.InProceedingsoftheEuropeanConferenceonComputerVision(ECCV),pages751–767,2018.[4]Q.Bateux,E.Marchand,J.Leitner,F.Chaumette,andP.Corke.Trainingdeepneuralnetworksforvisualservoing.InIEEEInt.Conf.onRoboticsandAutomation,ICRA’18,pages3307–3314,Brisbane,Australia,May2018.[5]JL.Bentley.Multidimensionalbinarysearchtreesusedforassociativesearching.CommunicationsoftheACM,18(9):509–517,1975.[6]F.Chaumette.Imagemoments:ageneralandusefulsetoffeaturesforvisualservoing.IEEETrans.onRobotics,20(4):713–723,August2004.[7]F.ChaumetteandS.Hutchinson.Visualservocontrol,PartI:Basicapproaches.IEEERoboticsandAutomationMagazine,13(4):82–90,December2006.[8]F.ChaumetteandE.Malis.21/2Dvisualservoing:apossiblesolutiontoimproveimage-basedandposition-basedvisualservoings.InIEEEInt.Conf.onRoboticsandAutomation,volume1,pages630–635,SanFrancisco,CA,April2000.[9]C.Collewet,E.Marchand,andF.Chaumette.Visualservoingsetfreefromimageprocessing.InIEEEInt.Conf.onRoboticsandAutomation,ICRA’08,pages81–86,Pasadena,CA,May2008.[10]X.DongandJ.Shen.Tripletlossinsiamesenetworkforobjecttracking.InProceedingsoftheEuropeanconferenceoncomputervision(ECCV),pages459–474,2018.[11]S.Felton,P.Brault,E.Fromont,andE.Marchand.VisualServoinginAutoencoderLatentSpace.IEEERoboticsandAutomationLetters,7(2):3234–3241,April2022.[12]K.He,X.Zhang,S.Ren,andJ.Sun.Deepresiduallearningforimagerecognition.2016IEEEConferenceonComputerVisionandPatternRecognition(CVPR),pages770–778,2016.[13]E.HofferandN.Ailon.Deepmetriclearningusingtripletnetwork.InInternationalworkshoponsimilarity-basedpatternrecognition,pages84–92.Springer,2015.[14]S.IoffeandC.Szegedy.Batchnormalization:Acceleratingdeepnetworktrainingbyreducinginternalcovariateshift.InICML’15,page448–456,2015.[15]D.JayaramanandK.Grauman.Learningimagerepresentationstiedtoego-motion.InProceedingsoftheIEEEInternationalConferenceonComputerVision,pages1413–1421,2015.[16]A.KendallandR.Cipolla.Geometriclossfunctionsforcameraposeregressionwithdeeplearning.2017IEEEConferenceonComputerVisionandPatternRecognition(CVPR),pages6555–6564,2017.[17]A.Kendall,M.Grimes,andR.Cipolla.Posenet:Aconvolutionalnetworkforreal-time6-dofcamerarelocalization.IEEEInternationalConferenceonComputerVision,ICCV,pages2938–2946,2015.[18]S.Kim,M.Seo,I.Laptev,M.Cho,andS.Kwak.Deepmetriclearningbeyondbinarysupervision.InProceedingsoftheIEEE/CVFConferenceonComputerVisionandPatternRecognition,pages2288–2297,2019.[19]D.KingmaandJ.Ba.Adam:Amethodforstochasticoptimization.2015Int.Conf.onLearningRepresentations(ICLR),2015.[20]E.Marchand.Controlcameraandlightsourcepositionsusingimagegradientinformation.InIEEEInt.Conf.onRoboticsandAutomation,ICRA’07,pages417–422,Roma,Italia,April2007.[21]E.Marchand.Subspace-basedvisualservoing.IEEERoboticsandAutomationLetters,4(3):2699–2706,July2019.[22]E.Marchand.Directvisualservoinginthefrequencydomain.IEEERoboticsandAutomationLetters,5(2):620–627,2020.[23]T.SalimansandD.Kingma.Weightnormalization:Asimplereparam-eterizationtoacceleratetrainingofdeepneuralnetworks.InNeuralInformationProcessingSystems2016,pages901–909,2016.[24]A.Saxena,H.Pandya,G.Kumar,A.Gaud,andK.M.Krishna.Exploringconvolutionalnetworksforend-to-endvisualservoing.InIEEEInt.Conf.onRoboticsandAutomation,ICRA’17,pages3817–3823,May2017.[25]J.Sung,I.Lenz,andA.Saxena.Deepmultimodalembedding:Ma-nipulatingnovelobjectswithpoint-clouds,languageandtrajectories.In2017IEEEInternationalConferenceonRoboticsandAutomation(ICRA),pages2794–2801.IEEE,2017.[26]V.Wan,Y.Agiomyrgiannakis,H.Silen,andJ.Vit.Google’snext-generationreal-timeunit-selectionsynthesizerusingsequence-to-sequencelstm-basedautoencoders.InINTERSPEECH,pages1143–1147,2017.[27]L.Wang,Y.Li,andS.Lazebnik.Learningdeepstructure-preservingimage-textembeddings.InProceedingsoftheIEEEconferenceoncomputervisionandpatternrecognition,pages5005–5013,2016.[28]L.E.Weiss.Dynamicvisualservocontrolofrobots.anadaptiveimagebasedapproach.TechnicalReportCMU-RI-TR-84-16,Carnegie-MellonUniversity,April1984.[29]W.Wilson,C.Hulls,andG.Bell.Relativeend-effectorcontrolusingcartesianposition-basedvisualservoing.IEEETrans.onRoboticsandAutomation,12(5):684–696,October1996.[30]M.Won,S.Oramas,O.Nieto,F.Gouyon,andX.Serra.Multimodalmetriclearningfortag-basedmusicretrieval.InICASSP2021-2021IEEEInternationalConferenceonAcoustics,SpeechandSignalProcessing(ICASSP),pages591–595.IEEE,2021.[31]C.Yu,Z.Cai,H.Pham,andQ.Pham.Siameseconvolutionalneuralnetworkforsub-millimeter-accuratecameraposeestimationandvisualservoing.2019IEEE/RSJInternationalConferenceonIntelligentRobotsandSystems(IROS),pages935–941,112019.[32]Z.Zhong,L.Zheng,G.Kang,S.Li,andY.Yang.Randomerasingdataaugmentation.InProceedingsoftheAAAIconferenceonartificialintelligence,volume34,pages13001–13008,2020.[33]Y.Zhou,C.Barnes,J.Lu,J.Yang,andH.Li.Onthecontinuityofrotationrepresentationsinneuralnetworks.InProceedingsoftheIEEE/CVFConferenceonComputerVisionandPatternRecognition,pages5745–5753,2019.